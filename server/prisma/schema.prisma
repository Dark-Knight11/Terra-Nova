generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")       // Pooled connection for queries
  directUrl = env("DATABASE_URL") // Direct connection for migrations
}

enum UserRole {
  COMPANY
  AUDITOR
  REGISTRY
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

model User {
  id           String   @id @default(uuid())
  email        String?  @unique
  passwordHash String?
  walletAddress String? @unique
  role         UserRole
  isVerified   Boolean  @default(false)
  nonce        String?  @unique
  nonceExpiry  DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  company   Company?
  auditor   Auditor?
  registry  Registry?
  sessions  Session[]
  wallets   Wallet[]

  @@index([email])
  @@index([walletAddress])
  @@index([role])
}

model Company {
  id                 String             @id @default(uuid())
  userId             String             @unique
  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name               String
  description        String?
  verificationStatus VerificationStatus @default(PENDING)
  walletAddress      String?            @unique
  country            String?
  industry           String?
  carbonFootprint    Decimal?           @db.Decimal(15, 2)
  credits            Decimal            @default(0) @db.Decimal(15, 2)
  
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  // Relations
  carbonCredits      CarbonCredit[]

  @@index([verificationStatus])
  @@index([walletAddress])
}

model Auditor {
  id                 String             @id @default(uuid())
  userId             String             @unique
  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name               String
  certifications     String[]
  verificationStatus VerificationStatus @default(PENDING)
  walletAddress      String?            @unique
  rating             Decimal?           @db.Decimal(3, 2)
  projectsAudited    Int                @default(0)
  
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  @@index([verificationStatus])
  @@index([walletAddress])
}

model Registry {
  id                 String             @id @default(uuid())
  userId             String             @unique
  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name               String
  jurisdiction       String?
  verificationStatus VerificationStatus @default(PENDING)
  walletAddress      String?            @unique
  creditsIssued      Decimal            @default(0) @db.Decimal(15, 2)
  
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt

  @@index([verificationStatus])
  @@index([walletAddress])
}

model Session {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  refreshToken String   @unique
  expiresAt    DateTime
  userAgent    String?
  ipAddress    String?
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
  @@index([refreshToken])
  @@index([expiresAt])
}

enum CreditType {
  REFORESTATION
  RENEWABLE_ENERGY
  SOLAR
  BLUE_CARBON
  PRESERVATION
  GEOTHERMAL
}

enum ProposalStatus {
  ACTIVE
  PASSED
  REJECTED
}

enum WalletStatus {
  VERIFIED
  PENDING
  REJECTED
}

model CarbonCredit {
  id             String     @id @default(uuid())
  title          String
  type           CreditType
  price          Decimal    @db.Decimal(10, 2)
  score          Int
  location       String
  image          String     // Gradient or image URL
  
  // Company relationship
  companyId      String
  company        Company    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  companyName    String     // Denormalized for performance
  
  description    String     @db.Text
  vintage        String
  volume         String
  methodology    String
  walletAddress  String?
  
  // Blockchain Sync
  projectId      String?    @unique // On-chain Project ID
  status         String     @default("PENDING") // PENDING, APPROVED, REJECTED
  
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  @@index([companyId])
  @@index([type])
  @@index([score])
  @@index([location])
}

model Wallet {
  id            String       @id @default(uuid())
  walletAddress String       @unique
  
  // Optional user relationship
  userId        String?      @unique
  user          User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  entity        String       // Denormalized entity name
  score         Int
  volume        String       // e.g., "125k"
  status        WalletStatus @default(PENDING)
  
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@index([walletAddress])
  @@index([status])
  @@index([score])
}

model Proposal {
  id            String         @id @default(uuid())
  title         String
  description   String?        @db.Text
  status        ProposalStatus @default(ACTIVE)
  votesFor      Int            @default(0)
  votesAgainst  Int            @default(0)
  endDate       DateTime?
  
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([status])
  @@index([createdAt])
}

enum ListingStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

model Listing {
  id            String        @id @default(uuid())
  listingId     String        @unique // On-chain listing ID
  projectId     String        // Token ID
  seller        String        // Wallet address
  amount        String        // BigInt as String
  price         String        // Price in Wei (BigInt as String)
  status        ListingStatus @default(ACTIVE)
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([projectId])
  @@index([seller])
  @@index([status])
}

model Trade {
  id            String   @id @default(uuid())
  listingId     String   // Reference to Listing
  buyer         String   // Wallet address
  seller        String   // Wallet address
  projectId     String   // Token ID
  amount        String   // Amount traded
  price         String   // Price per unit or total price (depending on logic)
  timestamp     DateTime @default(now())
  
  createdAt     DateTime @default(now())

  @@index([projectId])
  @@index([buyer])
  @@index([seller])
}
